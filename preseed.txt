### preseed.cfg - Unattended Debian install (adapté pour VM)
### Localisation / clavier / fuseau horaire
d-i debian-installer/locale string fr_FR.UTF-8
d-i console-setup/ask_detect boolean false
d-i console-setup/layoutcode string fr
d-i keyboard-configuration/layout string France
d-i keyboard-configuration/modelcode string pc105

d-i time/zone string Europe/Paris
d-i clock-setup/utc boolean true
d-i clock-setup/ntp boolean true

### Réseau (auto + hostname)
d-i netcfg/choose_interface select auto
d-i netcfg/get_hostname string debian-vm
d-i netcfg/get_domain string localdomain
# si tu veux forcer une interface précise (ex: enp0s25), remplacer la ligne précédente par :
# d-i netcfg/choose_interface select enp0s25

### Si tu veux forcer IPv4 DHCP (utile en VM)
d-i netcfg/disable_dhcp boolean false

### Dépôt (miroir français)
d-i mirror/country string manual
d-i mirror/http/hostname string deb.debian.org
d-i mirror/http/directory string /debian
d-i mirror/http/proxy string

### Partitionnement automatique (tout sur /)
d-i partman-auto/method string lvm
d-i partman-lvm/device_remove_lvm boolean true
d-i partman-lvm/confirm boolean true
d-i partman-auto/choose_recipe select atomic
d-i partman-auto/expert_recipe string                         \
      atomic ::                                              \
              1000 10000 1000000 ext4                         \
                      $primary{ } $bootable{ }                \
                      method{ format } format{ }              \
                      use_filesystem{ } filesystem{ ext4 }    \
                      mountpoint{ / }                         \
              .                                              
d-i partman/confirm boolean true
d-i partman/confirm_nooverwrite boolean true

### Utilisateur / mot de passe (mot de passe chiffré)
# Full name et username
d-i passwd/user-fullname string Tiago Martins
d-i passwd/username string tiago

# Mot de passe chiffré (SHA-512)
# Generated for password "titimdp12"
d-i passwd/user-password-crypted password $6$rounds=4096$Z.Wjjz/xu17eZHZm$5p4hqzVqef3sYO0hxe87/S44uGRIK0rRi7wWZRFVVZWhZvzwng9y8HZJtywFW9Va7sEprgnQdYUBs7A/Y9RA..

# Si tu veux aussi définir root (optionnel, ici root reste locké)
# d-i passwd/root-password-crypted password <hash-root>

### Paquets à installer
tasksel tasksel/first multiselect standard
d-i pkgsel/include string openssh-server htop
d-i pkgsel/upgrade select none
d-i pkgsel/install-language-support boolean false

### Boot loader
d-i grub-installer/only_debian boolean true
d-i grub-installer/with_other_os boolean true

### Nettoyage / fin
d-i finish-install/reboot_in_progress note

### Commandes tardives (late_command)
# - crée le fichier /home/tiago/helloworld.txt
# - s'assure de la bonne propriété et permissions
d-i preseed/late_command string \
    in-target /bin/sh -c "echo 'Hello World!' > /home/tiago/helloworld.txt"; \
    in-target /bin/chown tiago:tiago /home/tiago/helloworld.txt; \
    in-target /bin/chmod 644 /home/tiago/helloworld.txt; \
    # Si l'ISO est complet 4G: réécrire sources.list en miroir officiel FR (optionnel) \
    if [ -f /cdrom/.disk/info ]; then \
       in-target /bin/sh -c "sed -i 's@^deb http://.*@deb http://deb.debian.org/debian stable main contrib non-free@' /etc/apt/sources.list || true"; \
    fi
